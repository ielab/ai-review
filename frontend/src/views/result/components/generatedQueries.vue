<template>
  <div class="tw-bg-violet-100 tw-rounded-lg tw-w-full tw-justify-center tw-items-center tw-p-10">
    <div class="tw-grid tw-grid-cols-2">
      <div class="tw-flex tw-flex-col">
        <span class="tw-font-semibold tw-text-lg tw-mb-2">Generated Queries</span>
        <span>Queries generated by LARMOR model selection method</span>
      </div>
      <div class="tw-grid tw-grid-cols-2 tw-gap-10">
        <div class="tw-flex tw-flex-col">
          <span class="tw-font-semibold tw-mb-2">Download</span>
          <Button
            label="Query File"
            type="light"
            icon="pi pi-download"
            :isLoading="isLoading"
            @click="download('hash_pseudo_queries_path', 'pseudo_queries')"
          />
        </div>
        <div class="tw-flex tw-flex-col">
          <span class="tw-font-semibold tw-mb-2">Download</span>
          <Button
            label="QRel File"
            icon="pi pi-download"
            :isLoading="isLoading"
            @click="download('hash_pseudo_search_results_path', 'pseudo_search_results')"
          />
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { PropType } from 'vue'

import Button from '@/components/Button.vue'

import { IJob } from '@/types/data'

const props = defineProps({
  data: { type: Object as PropType<IJob>, required: true },
})

import { useError } from '@/composables/error'
const { getResponseErrorMessage } = useError()

import { useToast } from '@/composables/toast'
const { showToast } = useToast()

import { useLoading } from '@/composables/loading'
const { isLoading, setLoading } = useLoading(false)

/**
 * File Downloader
 */

import { getFileToDownload, downloadFileFromURL } from '@/utils/download'
import { AxiosError } from 'axios'

const download = async (key: keyof IJob, type: string) => {
  try {
    const hashPath = props.data[key] as string
    if (!hashPath) throw new Error('No file to download')
    setLoading(true)
    showToast('info', 'Downloading', `Please wait while downloading ${type} file`)
    const { url, filename } = await getFileToDownload(hashPath, type)
    downloadFileFromURL(url, filename)
    showToast('success', 'Downloaded', `${type} file downloaded successfully`)
  } catch (error) {
    if (error instanceof AxiosError) {
      const e = getResponseErrorMessage(error)
      showToast('error', 'Error on downloading', e.message)
    } else if (error instanceof Error) {
      showToast('error', 'Error on downloading', error.message)
    } else {
      showToast('error', 'Error on downloading', 'An unknown error occurred while downloading.')
    }
  } finally {
    setLoading(false)
  }
}
</script>
